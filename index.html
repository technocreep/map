<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>St. Petersburg Art Map | Mobile Optimized</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Roboto+Condensed:wght@700&display=swap');

        :root {
            --accent-yellow: #ffdf00;
            --accent-pink: #ff007f;
            --accent-blue: #00f3ff;
            --street-black: #1a1a1b;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Roboto Condensed', sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
        }

        #map { height: 100vh; width: 100%; z-index: 1; }

        .leaflet-container { background: #000 !important; }

        .header {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: var(--street-black); padding: 5px 15px;
            border: 3px solid var(--accent-yellow); box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
            pointer-events: none; text-align: center; width: auto; max-width: 90%;
        }

        .header h1 {
            margin: 0; font-family: 'Permanent Marker', cursive;
            color: var(--accent-yellow); font-size: 1.2rem;
            text-shadow: 2px 2px #ff007f;
        }

        .controls {
            position: absolute; bottom: 20px; left: 0; right: 0;
            z-index: 1000; display: flex; flex-direction: column; 
            align-items: center; gap: 10px; padding: 0 10px;
        }

        .btn-tag {
            color: white; border: 3px solid white; padding: 12px 25px;
            font-size: 16px; font-family: 'Permanent Marker', cursive;
            cursor: pointer; box-shadow: 4px 4px 0px #000;
            background: var(--accent-pink);
            pointer-events: auto;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-tag.active { background: #00ff00; color: black; }

        /* Custom Modal for Mobile */
        #custom-input {
            display: none;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000; background: var(--street-black);
            border: 4px solid var(--accent-yellow);
            padding: 20px; box-shadow: 10px 10px 0px #000;
            width: 280px;
        }

        #custom-input input {
            width: 100%; padding: 10px; box-sizing: border-box;
            background: #333; border: 2px solid white; color: white;
            font-family: 'Roboto Condensed'; margin-bottom: 10px;
        }

        #custom-input button {
            width: 100%; padding: 10px; background: var(--accent-pink);
            color: white; border: none; font-family: 'Permanent Marker';
            cursor: pointer;
        }

        .spray-icon svg {
            width: 32px; height: 32px;
            filter: drop-shadow(0px 0px 8px var(--accent-pink));
        }

        .insight-svg-layer { pointer-events: none !important; }
    </style>
</head>
<body>

    <div class="header">
        <h1>SPB STREET ART + ✨</h1>
    </div>

    <!-- Кастомное окно ввода для мобилок -->
    <div id="custom-input">
        <h2 style="color:var(--accent-yellow); margin-top:0; font-family:'Permanent Marker';">НОВЫЙ ТЕГ</h2>
        <input type="text" id="tag-name" placeholder="Название арта..." autocomplete="off">
        <button id="save-tag">СОХРАНИТЬ</button>
        <button id="cancel-tag" style="background:#555; margin-top:5px;">ОТМЕНА</button>
    </div>

    <div class="controls">
        <div id="helper" style="background:white; padding:5px; border:2px solid black; display:none; margin-bottom:5px; font-size:12px;">КЛИКНИ НА КАРТУ</div>
        <button id="addModeBtn" class="btn-tag">ТЕГНУТЬ</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Использование preferCanvas для мобильной производительности
        const map = L.map('map', { 
            zoomControl: false, 
            tap: true,
            zoomAnimation: true,
            fadeAnimation: true,
            preferCanvas: true,
            bounceAtZoomLimits: false
        }).setView([59.9386, 30.3141], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let savedPoints = [];
        const spotlightRadiusMeters = 200;
        let lastClickLatLng = null;

        const sprayIcon = L.divIcon({
            className: 'spray-icon',
            html: `<svg viewBox="0 0 512 512" fill="#ff007f">
                    <path d="M192 128h128v32H192zm144 64V160H176v32h-16v256c0 35.3 28.7 64 64 64h176c35.3 0 64-28.7 64-64V192h-16zm-32 256H208V224h96z"/>
                    <circle cx="256" cy="64" r="32"/>
                   </svg>`,
            iconSize: [32, 32],
            iconAnchor: [16, 32]
        });

        // SVG Оверлей
        const svgRenderer = L.svg({ padding: 0.5 });
        svgRenderer.addTo(map);
        const svgElement = svgRenderer._container;
        svgElement.classList.add('insight-svg-layer');

        const defs = L.SVG.create('defs');
        const mask = L.SVG.create('mask');
        mask.setAttribute('id', 'native-insight-mask');
        
        const maskBg = L.SVG.create('rect');
        maskBg.setAttribute('width', '100000%');
        maskBg.setAttribute('height', '100000%');
        maskBg.setAttribute('x', '-50000%');
        maskBg.setAttribute('y', '-50000%');
        maskBg.setAttribute('fill', 'white');
        
        const holesGroup = L.SVG.create('g');
        holesGroup.setAttribute('id', 'native-mask-holes');

        mask.appendChild(maskBg);
        mask.appendChild(holesGroup);
        defs.appendChild(mask);
        svgElement.appendChild(defs);

        const overlayRect = L.SVG.create('rect');
        overlayRect.setAttribute('width', '100000%');
        overlayRect.setAttribute('height', '100000%');
        overlayRect.setAttribute('x', '-50000%');
        overlayRect.setAttribute('y', '-50000%');
        overlayRect.setAttribute('fill', 'rgba(10, 10, 10, 0.69)');
        overlayRect.setAttribute('mask', 'url(#native-insight-mask)');
        overlayRect.setAttribute('style', 'filter: contrast(1.1);');
        svgElement.appendChild(overlayRect);

        function updateHoles() {
            holesGroup.innerHTML = '';
            savedPoints.forEach(p => {
                const latlng = L.latLng(p.lat, p.lng);
                const pos = map.latLngToLayerPoint(latlng);
                const point2 = L.latLng(p.lat, p.lng).toBounds(spotlightRadiusMeters).getNorthEast();
                const pos2 = map.latLngToLayerPoint(point2);
                const radius = Math.sqrt(Math.pow(pos2.x - pos.x, 2) + Math.pow(pos2.y - pos.y, 2));

                const circle = L.SVG.create('circle');
                circle.setAttribute('cx', pos.x);
                circle.setAttribute('cy', pos.y);
                circle.setAttribute('r', radius);
                circle.setAttribute('fill', 'black');
                circle.setAttribute('style', 'filter: blur(25px);');
                holesGroup.appendChild(circle);
            });
        }

        map.on('viewreset zoom move', updateHoles);

        // Функция сохранения в LocalStorage
        function saveData() {
            const dataToSave = savedPoints.map(p => ({ lat: p.lat, lng: p.lng, name: p.name }));
            localStorage.setItem('spb_art_tags', JSON.stringify(dataToSave));
        }

        // Загрузка данных
        function loadData() {
            const stored = localStorage.getItem('spb_art_tags');
            if (stored) {
                const points = JSON.parse(stored);
                points.forEach(addPoint);
            } else {
                // Дефолтные точки, если памяти нет
                const initialPoints = [
                    { lat: 59.9219, lng: 30.3555, name: "Лофт-проект Этажи" },
                    { lat: 59.9247, lng: 30.2415, name: "Севкабель Порт" },
                    { lat: 59.9398, lng: 30.3475, name: "Пушкинская 10" },
                    { lat: 59.9041, lng: 30.2974, name: "Бертгольд Центр" }
                ];
                initialPoints.forEach(addPoint);
            }
        }

        function addPoint(p) {
            const m = L.marker([p.lat, p.lng], { icon: sprayIcon }).addTo(map);
            m.bindPopup(`<b>${p.name}</b>`);
            savedPoints.push({ ...p, marker: m });
            updateHoles();
        }

        // Логика кастомного модального окна
        const modal = document.getElementById('custom-input');
        const inputField = document.getElementById('tag-name');
        const saveBtn = document.getElementById('save-tag');
        const cancelBtn = document.getElementById('cancel-tag');
        const addBtn = document.getElementById('addModeBtn');
        let isAddMode = false;

        addBtn.onclick = () => {
            isAddMode = !isAddMode;
            addBtn.classList.toggle('active');
            document.getElementById('helper').style.display = isAddMode ? 'block' : 'none';
        };

        map.on('click', (e) => {
            if (!isAddMode) return;
            lastClickLatLng = e.latlng;
            modal.style.display = 'block';
            inputField.focus();
        });

        saveBtn.onclick = () => {
            const name = inputField.value.trim();
            if (name && lastClickLatLng) {
                addPoint({ lat: lastClickLatLng.lat, lng: lastClickLatLng.lng, name: name });
                saveData();
            }
            closeModal();
        };

        cancelBtn.onclick = closeModal;

        function closeModal() {
            modal.style.display = 'none';
            inputField.value = '';
            isAddMode = false;
            addBtn.classList.remove('active');
            document.getElementById('helper').style.display = 'none';
        }

        // Инициализация
        loadData();
        setTimeout(updateHoles, 500);
    </script>
</body>
</html>
